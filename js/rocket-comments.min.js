/*! rocket-comments 2015-10-28 */
"use strict";var rocketComments=rocketComments||{};rocketComments.models=rocketComments.models||{},rocketComments.models.Comment=function(){var a=Backbone.Model.extend({children:[],idAttribute:"id",defaults:{id:null,author:null,author_avatar_urls:{24:"",48:"",56:"",96:""},author_email:"",author_ip:"",author_name:"",author_url:"",author_user_agent:"",content:{},date:new Date,date_gmt:new Date,karma:0,link:"",parent:0,post:null,type:"",_links:{}},sync:function(a,b,c){if(c=c||{},"undefined"!=typeof WP_API_Settings.nonce){var d=c.beforeSend;c.beforeSend=function(a){return a.setRequestHeader("X-WP-Nonce",WP_API_Settings.nonce),d?d.apply(this,arguments):void 0}}return b&&"object"==typeof b&&"url"in b?Backbone.sync(a,b,c):void 0},url:function(){var a=this.get("id");return a=a||"",WP_API_Settings.root+"/comments/"+a},initialize:function(){var a=new Date(this.get("date"));this.set({iso_string:a.toISOString()})}});return a}();var rocketComments=rocketComments||{};rocketComments.views=rocketComments.views||{},rocketComments.views.Comment=function(){var a=Backbone.View.extend({tagName:"li",initialize:function(){this.template=jQuery("#comment-template").length?_.template(jQuery("#comment-template").html()):void 0},render:function(a){return void 0===this.template||void 0==this.model?this:(this.$el.html(this.template(this.model)).attr("id","comment-"+this.model.get("id")).addClass(a).data("comment-id",this.model.get("id")),this)}});return a}();var rocketComments=rocketComments||{};rocketComments.views=rocketComments.views||{},rocketComments.views.Comments=function(){var a=Backbone.View.extend({el:".comments-area",events:{"click .comment-respond .submit":"submitComment"},initialize:function(){this.collection=new rocketComments.collections.Comments,this.collection.post_id=this.$el.data("post-id"),this.collection.user_id=this.$el.data("user-id"),this.collection.user_name=this.$el.data("user-name"),this.collection.user_avatar=this.$el.data("user-avatar"),this.page_comments=this.$el.data("page-comments"),this.comment_page=this.$el.data("comment-page"),this.comments_per_page=this.$el.data("comments-per-page"),this.fetch_time=1e3*parseInt(this.$el.data("fetch-time")),this.loading=!0,this.fetchComments()},updateNavigationLinks:function(){if(this.total_pages>1){var a=jQuery(".comment-navigation");if(a.show(),this.comment_page>1)void 0!==this.$nav_previous_children&&(a.find(".nav-previous").append(this.$nav_previous_children),this.$nav_previous_children=void 0);else{var b=a.find(".nav-previous").children().detach();b.length>0&&(this.$nav_previous_children=b)}return this.comment_page<this.total_pages?jQuery(".nav-next").show():jQuery(".nav-next").hide(),!0}return!1},render:function(){var a=this.$el.find("ol#comment-root");a.empty(),_.isEmpty(this.collection)||(this.collection.each(function(b){var c=this.collection.commentDepth(b),d="",e=a;if(b.get("parent")>0&&c>1){var f=jQuery("#ol-comment-"+b.get("parent"));0!==f.length&&(e=f)}b.get("author")==this.collection.user_id&&(d=" bypostauthor");var g=new rocketComments.views.Comment({model:b});e.append(g.render("comment depth-"+c+d).el)},this),jQuery(".comments-area .comments-title").css("display","none"),jQuery(".comment-edit-link").click(_.bind(this.populateEditForm,this)),jQuery(".comment-reply-link").click(function(a){a.preventDefault(),rocketComments.startForm(a,"reply")}))},submitComment:function(a){if(!(_.isObject(a)&&"preventDefault"in a))return!1;a.preventDefault();var b,c,d=jQuery(a.currentTarget).closest("li"),e=d.data("comment-id"),f=jQuery(".comment-respond"),g=f.find("input#author").val(),h=f.find("input#email").val(),i=f.find("input#url").val(),j=f.find("textarea#comment").val(),k=f.data("action");"edit"==k?(c=this.collection.get(jQuery("#respond").data("comment-id")),c.set({content:j,type:""}),c.save({},{success:_.bind(function(a,b){null!==b&&(this.collection.set(c,{remove:!1}),this.render())},this),error:_.bind(this.handleError,this)})):(b={id:null,author:this.collection.user_id,author_email:h,author_name:g,author_url:i,content:j,parent:e,post:this.collection.post_id},c=new rocketComments.models.Comment(b),c.save({},{success:_.bind(function(a,b){null!==b&&this.collection.add(c),this.render()},this),error:_.bind(this.handleError,this)})),jQuery("#cancel-comment-reply-link").trigger("click"),f.find("textarea#comment").val(""),this.render()},showNotify:function(a,b){var c=jQuery("#comment-notify");void 0===a&&(a=c.data("default")),c.text(a).fadeIn(),void 0!==b&&setTimeout(this.fadeNotify,b)},fadeNotify:function(){jQuery("#comment-notify").fadeOut()},handleError:function(a,b){if(!b||!b.hasOwnProperty("responseText"))return!1;var c=jQuery.parseJSON(b.responseText);this.showNotify(c[0].message,5e3)},fetchComments:function(){var a={page:this.comment_page};this.comments_per_page>0&&(a.per_page=this.comments_per_page),this.loading&&(this.loading=!1,jQuery("div#wp-loading").fadeOut(100,function(){jQuery("#wp-comment-content").fadeIn(100)})),this.showNotify(),this.collection.fetch({data:a,success:_.bind(function(a,b,c){this.total_comments=parseInt(c.xhr.getResponseHeader("X-WP-Total")),this.total_pages=parseInt(c.xhr.getResponseHeader("X-WP-TotalPages")),1==this.total_comments?jQuery(".comments-area #comment-single").fadeIn():(jQuery("span#comment-count").html(this.total_comments),jQuery(".comments-area #comment-multiple").fadeIn()),this.updateNavigationLinks(),this.fadeNotify(),this.render(),clearTimeout(this.timeout),this.fetch_time>0&&(this.timeout=setTimeout(this.fetchComments.bind(this),this.fetch_time))},this),error:_.bind(this.handleError,this)})},populateEditForm:function(a){var b,c,d=jQuery("#respond");a.preventDefault(),c=jQuery(a.target).data("id"),b=this.collection.get(c),b.get("author")!=this.collection.user_id&&(jQuery(".comment-author-logged-in").hide(),jQuery(".comment-author-not-logged-in").show(),d.find("#author").val(b.get("author_name")),d.find("#email").val(b.get("author_email")),d.find("#url").val(b.get("author_url")),d.find("#comment").val(b.get("content").raw)),rocketComments.startForm(a,"edit")}});return a}();var rocketComments=rocketComments||{};rocketComments.collections=rocketComments.collections||{},rocketComments.collections.Comments=function(){var a=wp.api.collections.Comments.extend({initialize:function(){this.order=jQuery(".comments-area").data("comment-order"),this.model=rocketComments.models.Comment,this.state={}},url:function(){return this.post_id?WP_API_Settings.root+"/comments/?orderby=id&order="+this.order+"&post="+this.post_id:WP_API_Settings.root+"/comments/"},commentDepth:function(a){var b=1;if(!(_.isObject(a)&&"get"in a))return b;for(;a&&a.get("parent")>0;)a=this.where({id:a.get("parent")})[0],b+=1;return void 0===this.threaded&&(this.threaded=jQuery("div#comments").data("threaded")||1),b<this.threaded?b:this.threaded}});return a}();var rocketComments=rocketComments||{};rocketComments.start=function(){if(rocketComments.cache={},jQuery("#wp-loading").show(),void 0===rocketComments.started){var a=new rocketComments.views.Comments;rocketComments.started=!0,jQuery(".comment-navigation .nav-previous a").on("click",function(){rocketComments.shiftPage.call(a,-1)}),jQuery(".comment-navigation .nav-next a").on("click",function(){rocketComments.shiftPage.call(a,1)})}jQuery("form#commentform").submit(function(a){a.preventDefault()})},rocketComments.shiftPage=function(a){this.comment_page+=a,this.fetchComments(this.collection)},rocketComments.startForm=function(a,b){var c=jQuery(a.target).data("id"),d=this.get("#cancel-comment-"+b+"-link"),e=this.get("#respond"),f=this.get("#div-comment-"+c);"edit"===b&&f.hide(),this.setupTempForm(),this.showCommentTitle(b),e.data("comment-id",c).data("action",b).insertBefore(f.next()),this.get("#comment").focus(),d.show().click(function(){rocketComments.cancelForm.call(this,f)})},rocketComments.setupTempForm=function(){if(!jQuery("#wp-temp-form-div").length){var a=jQuery('<div id="wp-temp-form-div" style="display: none;"></div>');rocketComments.get("#respond").parent().append(a)}},rocketComments.showCommentTitle=function(a){this.get(".comment-reply-title").hide(),this.get(".title-"+a).show()},rocketComments.resetForm=function(){var a=jQuery("#wp-temp-form-div"),b=this.get("#respond");return a.length&&b.length?(a.parent().append(b),a.remove(),this.get("#comment").val(""),this.showCommentTitle("reply"),b.removeData(["action","comment-id"]),!0):!1},rocketComments.cancelForm=function(a){return void 0!==a&&a.show(),jQuery(this).hide().prop("onclick",null),rocketComments.resetForm(this),rocketComments.get(".comment-author-not-logged-in").hide(),rocketComments.get(".comment-author-logged-in").show(),!1},rocketComments.get=function(a){return void 0===rocketComments.cache[a]&&rocketComments.set(a,jQuery(a)),rocketComments.peek(a)},rocketComments.peek=function(a){return rocketComments.cache[a]},rocketComments.set=function(a,b){rocketComments.cache[a]=b};