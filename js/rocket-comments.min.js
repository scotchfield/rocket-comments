/*! rocket-comments 2015-10-06 */
"use strict";var rocketComments=rocketComments||{};rocketComments.CommentModel=Backbone.Model.extend({children:[],idAttribute:"id",defaults:{id:null,author:null,author_avatar_urls:{24:"",48:"",56:"",96:""},author_email:"",author_ip:"",author_name:"",author_url:"",author_user_agent:"",content:{},date:new Date,date_gmt:new Date,karma:0,link:"",parent:0,post:null,type:"",_links:{}},sync:function(a,b,c){if(c=c||{},"undefined"!=typeof WP_API_Settings.nonce){var d=c.beforeSend;c.beforeSend=function(a){return a.setRequestHeader("X-WP-Nonce",WP_API_Settings.nonce),d?d.apply(this,arguments):void 0}}return!b||"object"!=typeof b||!1 in b?void 0:Backbone.sync(a,b,c)},url:function(){var a=this.get("id");return a=a||"",WP_API_Settings.root+"/comments/"+a},initialize:function(){var a=new Date(this.get("date"));this.set({iso_string:a.toISOString()}),this.set({edit_class:"hidden"}),1==this.get("edit")&&this.set({edit_class:""})}});var rocketComments=rocketComments||{};rocketComments.CommentView=Backbone.View.extend({tagName:"li",initialize:function(){this.template=jQuery("#comment-template").length?_.template(jQuery("#comment-template").html()):void 0},render:function(a){return void 0===this.template||void 0==this.model?this:(this.$el.html(this.template(this.model)).attr("id","comment-"+this.model.get("id")).addClass(a).data("comment-id",this.model.get("id")),this)}});var rocketComments=rocketComments||{};rocketComments.CommentsView=Backbone.View.extend({el:".comments-area",events:{"click .comment-respond .submit":"submitComment"},initialize:function(){var a={};this.collection=new rocketComments.CommentsCollection,this.listenTo(this.collection,"add",this.render),this.collection.post_id=this.$el.data("post-id"),this.collection.user_id=this.$el.data("user-id"),this.collection.user_name=this.$el.data("user-name"),this.collection.user_avatar=this.$el.data("user-avatar"),this.page_comments=this.$el.data("page-comments"),this.comment_page=this.$el.data("comment-page"),this.comments_per_page=this.$el.data("comments-per-page"),this.page_comments>0&&(a={page:this.comment_page,per_page:this.comments_per_page}),this.collection.fetch({data:a,success:_.bind(function(a,b,c){jQuery("div#wp-loading").fadeOut(400,function(){jQuery("#wp-comment-content").fadeIn(400)}),this.total_comments=parseInt(c.xhr.getResponseHeader("X-WP-Total")),this.total_pages=parseInt(c.xhr.getResponseHeader("X-WP-TotalPages")),1==this.total_comments?jQuery(".comments-area #comment-single").fadeIn():(jQuery("span#comment-count").html(this.total_comments),jQuery(".comments-area #comment-multiple").fadeIn()),this.updateNavigationLinks(),void 0!==this.interval&&clearTimeout(this.interval),this.interval=setInterval(this.fetchComments.bind(this),1e4)},this),error:function(){console.log("Error: Could not retrieve comments!")}})},updateNavigationLinks:function(){if(this.total_pages>1){if(jQuery(".comment-navigation").show(),this.comment_page>1)void 0!==this.$nav_previous_children&&(jQuery(".nav-previous").append(this.$nav_previous_children),this.$nav_previous_children=void 0);else{var a=jQuery(".nav-previous").children().detach();a.length>0&&(this.$nav_previous_children=a)}this.comment_page<this.total_pages?jQuery(".nav-next").show():jQuery(".nav-next").hide()}},render:function(){var a=this.$el.find("ol#comment-root");a.empty(),_.isEmpty(this.collection)||(this.collection.each(function(b){var c=this.collection.commentDepth(b),d="";if(b.get("parent")>0&&c>1){var e=jQuery("ol#ol-comment-"+b.get("parent"));0!==e.length&&(a=e)}b.get("author")==this.collection.user_id&&(d=" bypostauthor");var f=new rocketComments.CommentView({model:b});a.append(f.render("comment depth-"+c+d).el)},this),jQuery(".comments-area .comments-title").css("display","none"))},submitComment:function(a){a.preventDefault();var b,c,d=jQuery(a.currentTarget).closest("li"),e=d.data("comment-id"),f=jQuery(".comment-respond input#author").val(),g=jQuery(".comment-respond input#email").val(),h=jQuery(".comment-respond input#url").val(),i=jQuery(".comment-respond textarea#comment").val(),j=jQuery("#respond").data("action");"edit"==j?(c=this.collection.get(jQuery("#respond").data("comment-id")),c.set({content:i,type:""}),c.save({},{success:function(a,b){null!==b&&rocketComments.commentsView.collection.set(c,{remove:!1})},error:function(a,b){console.log("Error!"),console.log(b)}})):(b={id:null,author:this.collection.user_id,author_email:g,author_name:f,author_url:h,content:i,parent:e,post:this.collection.post_id},c=new rocketComments.CommentModel(b),c.save({},{success:function(a,b){null!==b&&rocketComments.commentsView.collection.add(c)},error:function(a,b){console.log("Error!"),console.log(b)}})),jQuery("#cancel-comment-reply-link").trigger("click"),jQuery("#respond textarea#comment").val(""),this.render()},fetchComments:function(){var a={};this.page_comments>0&&(a={page:this.comment_page,per_page:this.comments_per_page}),this.collection.fetch({data:a,success:_.bind(function(a,b,c){this.total_comments=c.xhr.getResponseHeader("X-WP-Total"),this.total_pages=c.xhr.getResponseHeader("X-WP-TotalPages"),1==this.total_comments?jQuery(".comments-area #comment-single").fadeIn():(jQuery("span#comment-count").html(this.total_comments),jQuery(".comments-area #comment-multiple").fadeIn()),this.updateNavigationLinks()},this),error:function(){console.log("Error: Could not update collection!")}})}});var rocketComments=rocketComments||{};rocketComments.CommentsCollection=wp.api.collections.Comments.extend({initialize:function(){this.order=jQuery(".comments-area").data("comment-order"),this.model=rocketComments.CommentModel,this.state={}},url:function(){return this.post_id?WP_API_Settings.root+"/comments/?orderby=id&order="+this.order+"&post="+this.post_id:WP_API_Settings.root+"/comments/"},commentDepth:function(a){for(var b=1;a&&a.get("parent")>0;)a=this.where({id:a.get("parent")})[0],b+=1;return this.threaded||(this.threaded=jQuery("div#comments").data("threaded")),b<this.threaded?b:this.threaded}});var rocketComments=rocketComments||{},addComment=addComment||{};rocketComments.shiftPage=function(a){rocketComments.commentsView.comment_page+=a,rocketComments.commentsView.fetchComments(rocketComments.commentsView.collection)},rocketComments.start=function(){jQuery("#wp-loading").show(),void 0===rocketComments.commentsView&&(rocketComments.commentsView=new rocketComments.CommentsView),jQuery(".comment-navigation .nav-previous a").on("click",function(){rocketComments.shiftPage(-1)}),jQuery(".comment-navigation .nav-next a").on("click",function(){rocketComments.shiftPage(1)})},addComment.setupForm=function(a,b,c,d){var e,f;jQuery(b).trigger("click"),this.I("wp-temp-form-div")||(e=document.createElement("div"),e.id="wp-temp-form-div",e.style.display="none",c.parentNode.insertBefore(e,c)),f=jQuery("#cancel-comment-reply-link").parent(),jQuery("h3#reply-title").html(jQuery("div#comments").data("comment-title-"+d)).append(jQuery("<small>").append(f)),jQuery("#respond").data("comment-id",a),jQuery("#respond").data("action",d)},addComment.resetForm=function(a){var b=addComment.I("wp-temp-form-div"),c=addComment.I(addComment.respondId);b&&c&&(b.parentNode.insertBefore(c,b),b.parentNode.removeChild(b),a.style.display="none",a.onclick=null,jQuery("#respond textarea#comment").val(""),jQuery("#respond").removeData("action"),jQuery("#respond").removeData("comment-id"))},addComment.moveForm=function(a,b,c,d){var e=this.I(a),f=this.I(c),g=this.I("cancel-comment-reply-link"),h=this.I("comment_parent"),i=this.I("comment_post_ID");if(e&&f&&g&&h){addComment.setupForm(a,g,f,"reply"),this.respondId=c,d=d||!1,e.parentNode.insertBefore(f,e.nextSibling),i&&d&&(i.value=d),h.value=b,g.style.display="",g.onclick=function(){return addComment.resetForm(this),addComment.I("comment_parent").value="0",!1};try{this.I("comment").focus()}catch(j){}return!1}},addComment.editForm=function(a,b){var c,d,e=this.I("div-comment-"+a),f=this.I(b),g=this.I("cancel-comment-reply-link");if(e&&f&&g){addComment.setupForm(a,g,f,"edit"),this.respondId=b,e.parentNode.insertBefore(f,e.nextSibling),g.style.display="",c=rocketComments.commentsView.collection.get(a),c.get("author")!=rocketComments.commentsView.collection.user_id&&(jQuery(".comment-author-logged-in").hide(),jQuery(".comment-author-not-logged-in").show(),jQuery(".comment-respond #author").val(c.get("author_name")),jQuery(".comment-respond #email").val(c.get("author_email")),jQuery(".comment-respond #url").val(c.get("author_url"))),d=jQuery("#div-comment-"+a+" .comment-content").text(),jQuery("#respond textarea#comment").val(d.trim()),jQuery("#div-comment-"+a).hide(),g.onclick=function(){return addComment.resetForm(this),jQuery("#div-comment-"+a).show(),jQuery(".comment-author-not-logged-in").hide(),jQuery(".comment-author-logged-in").show(),!1};try{addComment.I("comment").focus()}catch(h){}return!1}},jQuery("form#commentform").submit(function(a){a.preventDefault()});