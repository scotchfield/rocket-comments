/*! rocket-comments 2015-10-10 */
"use strict";var rocketComments=rocketComments||{};rocketComments.models=rocketComments.models||{},rocketComments.models.Comment=function(){var a=Backbone.Model.extend({children:[],idAttribute:"id",defaults:{id:null,author:null,author_avatar_urls:{24:"",48:"",56:"",96:""},author_email:"",author_ip:"",author_name:"",author_url:"",author_user_agent:"",content:{},date:new Date,date_gmt:new Date,karma:0,link:"",parent:0,post:null,type:"",_links:{}},sync:function(a,b,c){if(c=c||{},"undefined"!=typeof WP_API_Settings.nonce){var d=c.beforeSend;c.beforeSend=function(a){return a.setRequestHeader("X-WP-Nonce",WP_API_Settings.nonce),d?d.apply(this,arguments):void 0}}return b&&"object"==typeof b&&"url"in b?Backbone.sync(a,b,c):void 0},url:function(){var a=this.get("id");return a=a||"",WP_API_Settings.root+"/comments/"+a},initialize:function(){var a=new Date(this.get("date"));this.set({iso_string:a.toISOString()}),this.set({edit_class:"hidden"}),1==this.get("edit")&&this.set({edit_class:""})}});return a}();var rocketComments=rocketComments||{};rocketComments.views=rocketComments.views||{},rocketComments.views.Comment=function(){var a=Backbone.View.extend({tagName:"li",initialize:function(){this.template=jQuery("#comment-template").length?_.template(jQuery("#comment-template").html()):void 0},render:function(a){return void 0===this.template||void 0==this.model?this:(this.$el.html(this.template(this.model)).attr("id","comment-"+this.model.get("id")).addClass(a).data("comment-id",this.model.get("id")),this)}});return a}();var rocketComments=rocketComments||{};rocketComments.views=rocketComments.views||{},rocketComments.views.Comments=function(){var a=Backbone.View.extend({el:".comments-area",events:{"click .comment-respond .submit":"submitComment"},initialize:function(){this.collection=new rocketComments.collections.Comments,this.listenTo(this.collection,"add",this.render),this.collection.post_id=this.$el.data("post-id"),this.collection.user_id=this.$el.data("user-id"),this.collection.user_name=this.$el.data("user-name"),this.collection.user_avatar=this.$el.data("user-avatar"),this.page_comments=this.$el.data("page-comments"),this.comment_page=this.$el.data("comment-page"),this.comments_per_page=this.$el.data("comments-per-page"),this.loading=!0,this.fetchComments()},updateNavigationLinks:function(){if(this.total_pages>1){if(jQuery(".comment-navigation").show(),this.comment_page>1)void 0!==this.$nav_previous_children&&(jQuery(".nav-previous").append(this.$nav_previous_children),this.$nav_previous_children=void 0);else{var a=jQuery(".nav-previous").children().detach();a.length>0&&(this.$nav_previous_children=a)}this.comment_page<this.total_pages?jQuery(".nav-next").show():jQuery(".nav-next").hide()}},render:function(){var a=this.$el.find("ol#comment-root");a.empty(),_.isEmpty(this.collection)||(this.collection.each(function(b){var c=this.collection.commentDepth(b),d="";if(b.get("parent")>0&&c>1){var e=jQuery("#ol-comment-"+b.get("parent"));0!==e.length&&(a=e)}b.get("author")==this.collection.user_id&&(d=" bypostauthor");var f=new rocketComments.views.Comment({model:b});a.append(f.render("comment depth-"+c+d).el)},this),jQuery(".comments-area .comments-title").css("display","none"))},submitComment:function(a){a.preventDefault();var b,c,d=jQuery(a.currentTarget).closest("li"),e=d.data("comment-id"),f=jQuery(".comment-respond"),g=f.find("input#author").val(),h=f.find("input#email").val(),i=f.find("input#url").val(),j=f.find("textarea#comment").val(),k=f.data("action");"edit"==k?(c=this.collection.get(jQuery("#respond").data("comment-id")),c.set({content:j,type:""}),c.save({},{success:function(a,b){null!==b&&rocketComments.commentsView.collection.set(c,{remove:!1})},error:function(a,b){console.log("Error!"),console.log(b)}})):(b={id:null,author:this.collection.user_id,author_email:h,author_name:g,author_url:i,content:j,parent:e,post:this.collection.post_id},c=new rocketComments.models.Comment(b),c.save({},{success:function(a,b){null!==b&&rocketComments.commentsView.collection.add(c)},error:function(a,b){console.log("Error!"),console.log(b)}})),jQuery("#cancel-comment-reply-link").trigger("click"),f.find("textarea#comment").val(""),this.render()},fetchComments:function(){var a={};this.loading&&(this.loading=!1,jQuery("div#wp-loading").fadeOut(100,function(){jQuery("#wp-comment-content").fadeIn(100)})),this.page_comments>0&&(a={page:this.comment_page,per_page:this.comments_per_page}),this.collection.fetch({data:a,success:_.bind(function(a,b,c){this.total_comments=c.xhr.getResponseHeader("X-WP-Total"),this.total_pages=c.xhr.getResponseHeader("X-WP-TotalPages"),1==this.total_comments?jQuery(".comments-area #comment-single").fadeIn():(jQuery("span#comment-count").html(this.total_comments),jQuery(".comments-area #comment-multiple").fadeIn()),this.updateNavigationLinks()},this),error:function(){console.log("Error: Could not update collection!")}}),this.timeout=setTimeout(this.fetchComments.bind(this),1e4)}});return a}();var rocketComments=rocketComments||{};rocketComments.collections=rocketComments.collections||{},rocketComments.collections.Comments=function(){var a=wp.api.collections.Comments.extend({initialize:function(){this.order=jQuery(".comments-area").data("comment-order"),this.model=rocketComments.models.Comment,this.state={}},url:function(){return this.post_id?WP_API_Settings.root+"/comments/?orderby=id&order="+this.order+"&post="+this.post_id:WP_API_Settings.root+"/comments/"},commentDepth:function(a){for(var b=1;a&&a.get("parent")>0;)a=this.where({id:a.get("parent")})[0],b+=1;return this.threaded||(this.threaded=jQuery("div#comments").data("threaded")),b<this.threaded?b:this.threaded}});return a}();var rocketComments=rocketComments||{};rocketComments.start=function(){jQuery("#wp-loading").show(),void 0===rocketComments.commentsView&&(rocketComments.commentsView=new rocketComments.views.Comments),jQuery(".comment-navigation .nav-previous a").on("click",function(){rocketComments.shiftPage(-1)}),jQuery(".comment-navigation .nav-next a").on("click",function(){rocketComments.shiftPage(1)}),jQuery("form#commentform").submit(function(a){a.preventDefault()})},rocketComments.shiftPage=function(a){this.commentsView.comment_page+=a,this.commentsView.fetchComments(this.commentsView.collection)};var addComment=addComment||{};addComment.setupForm=function(a){var b;a.cancel.parent();jQuery("#wp-temp-form-div").length||(b=jQuery('<div id="wp-temp-form-div" style="display: none;"></div>'),jQuery(a.respond).parent().append(b)),jQuery(a.cancel).trigger("click"),a.respond.data("comment-id",a.commentId),a.respond.data("action",a.action),a.respond.insertBefore(a.comment.next()),a.cancel.show(),this.respondId=a.respondId,jQuery(".comment-reply-title").hide(),jQuery(".title-"+a.action).show(),jQuery("a#cancel-comment-reply-link").show(),jQuery("#comment").focus()},addComment.resetForm=function(a){var b=jQuery("#wp-temp-form-div"),c=jQuery("#"+addComment.respondId);b.length&&c.length&&(b.parent().append(c),b.remove(),jQuery(a).hide().prop("onclick",null),c.find("textarea#comment").val(""),c.removeData("action").removeData("comment-id"))},addComment.moveForm=function(a,b,c,d){var e=jQuery("#"+a),f=jQuery("#"+c),g=jQuery(".title-reply #cancel-comment-reply-link"),h=jQuery("#comment_post_ID");if(e.length&&f.length&&g.length)return addComment.setupForm({action:"reply",cancel:g,comment:e,commentId:a,respond:f,respondId:c}),addComment.setParentValue(b),d=d||!1,h.length&&d&&h.val(d),g.click(function(){return addComment.resetForm(this),addComment.setParentValue("0"),!1}),!1},addComment.editForm=function(a,b){var c,d,e=jQuery("#div-comment-"+a),f=jQuery("#"+b),g=jQuery(".title-edit #cancel-comment-reply-link");if(e.length&&f.length&&g.length)return addComment.setupForm({action:"edit",cancel:g,comment:e,commentId:a,respond:f,respondId:b}),c=rocketComments.commentsView.collection.get(a),c.get("author")!=rocketComments.commentsView.collection.user_id&&(jQuery(".comment-author-logged-in").hide(),jQuery(".comment-author-not-logged-in").show(),f.find("#author").val(c.get("author_name")),f.find("#email").val(c.get("author_email")),f.find("#url").val(c.get("author_url"))),d=e.children(".comment-content").text(),f.find("textarea#comment").val(d.trim()),e.hide(),g.click(function(){return addComment.resetForm(this),e.show(),jQuery(".comment-author-not-logged-in").hide(),jQuery(".comment-author-logged-in").show(),!1}),!1},addComment.setParentValue=function(a){addComment.hasOwnProperty("commentParent")||(addComment.commentParent=jQuery("#comment_parent")),addComment.commentParent.val(a)};